<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<title>Monitoraggio Distributori Iperstaroil</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
#map { height: 75vh; border-radius: 0.5rem; }
.card { margin-bottom: 1rem; }
</style>
</head>
<body>
<header class="bg-dark text-white p-3 mb-3">
  <div class="container">
    <h2 class="mb-0">Monitoraggio Distributori Iperstaroil</h2>
  </div>
</header>

<main class="container">
  <div class="row g-3">
    <div class="col-md-4">
      <div class="card p-3">
        <h5>Elenco distributori (tutti)</h5>
        <button id="btn-list-all" class="btn btn-primary btn-sm mb-2">Mostra elenco</button>
        <div id="list-all"></div>
      </div>

      <div class="card p-3">
        <h5>Ricerca per provincia</h5>
        <input id="prov-input" type="text" class="form-control form-control-sm mb-2" placeholder="Es. Milano">
        <button id="btn-prov" class="btn btn-primary btn-sm mb-2">Cerca</button>
        <div id="prov-result"></div>
      </div>

      <div class="card p-3">
        <h5>Ricerca per ID distributore</h5>
        <input id="id-input" type="number" min="1" class="form-control form-control-sm mb-2">
        <button id="btn-id" class="btn btn-primary btn-sm mb-2">Cerca</button>
        <div id="id-result"></div>
      </div>

      <div class="card p-3">
        <h5>Cambio prezzo per provincia</h5>
        <input id="prov-price" type="text" class="form-control form-control-sm mb-2" placeholder="Es. Milano">
        <select id="tipo-price" class="form-select form-select-sm mb-2">
          <option value="benzina">Benzina</option>
          <option value="diesel">Diesel</option>
        </select>
        <input id="new-price" type="number" step="0.01" class="form-control form-control-sm mb-2" placeholder="Nuovo prezzo (€)">
        <button id="btn-change-price" class="btn btn-primary btn-sm mb-2">Aggiorna prezzi</button>
        <div id="change-result"></div>
      </div>
    </div>

    <div class="col-md-8">
      <div class="card p-3">
        <h5>Mappa distributori</h5>
        <div id="map"></div>
      </div>
    </div>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// Mappa
const map = L.map('map').setView([41.9, 12.5], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);
const markers = L.layerGroup().addTo(map);

// --- Funzioni ---
function aggiornaMappa(data) {
    markers.clearLayers();
    if (!Array.isArray(data)) data = [data];
    
    data.forEach(d => {
        const lat = d.lat;
        const lon = d.lon;
        if (!lat || !lon) return;

        const popup = `<b>${d.nome} (ID ${d.id_distributore ?? 'n/a'})</b><br/>
                       Provincia: ${d.provincia}<br/>
                       Benzina: ${d.capienza_benzina} L (€${d.prezzo_benzina})<br/>
                       Diesel: ${d.capienza_diesel} L (€${d.prezzo_diesel})<br/>
                       Pompe: ${d.numero_pompe}`;
        L.marker([lat, lon]).addTo(markers).bindPopup(popup);
    });

    if (data.length) {
        const coords = data.filter(d => d.lat && d.lon).map(d => [d.lat, d.lon]);
        if (coords.length) map.fitBounds(L.latLngBounds(coords).pad(0.2));
    }
}

function generaElenco(data, containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = "";
    if (!Array.isArray(data)) data = [data];

    data.forEach(d => {
        const el = document.createElement('div');
        el.className = 'card p-2 mb-2';
        el.innerHTML = `<strong>${d.nome} (ID ${d.id_distributore ?? 'n/a'})</strong><br/>
                        Provincia: ${d.provincia}<br/>
                        Benzina: ${d.capienza_benzina} L (€${d.prezzo_benzina})<br/>
                        Diesel: ${d.capienza_diesel} L (€${d.prezzo_diesel})<br/>
                        Pompe: ${d.numero_pompe}`;
        container.appendChild(el);
    });
}

async function safeFetch(url, options) {
    const res = await fetch(url, options);
    if (!res.ok) {
        const text = await res.text();
        throw new Error(text || `Errore ${res.status}`);
    }
    return await res.json();
}

// --- Eventi ---
// Elenco completo
let elencoVisibile = false;
document.getElementById('btn-list-all').addEventListener('click', async () => {
    const btn = document.getElementById('btn-list-all');
    const containerId = 'list-all';
    
    if (elencoVisibile) {
        document.getElementById(containerId).innerHTML = "";
        markers.clearLayers();
        btn.innerText = "Mostra elenco";
        elencoVisibile = false;
        return;
    }
    
    try {
        let data = await safeFetch('/distributori');
        if (!data.length) alert("Nessun distributore trovato.");
        generaElenco(data, containerId);
        aggiornaMappa(data);
        btn.innerText = "Nascondi elenco";
        elencoVisibile = true;
    } catch (err) {
        alert("Errore nel recupero dei distributori: " + (err.message || err));
    }
});

document.getElementById('btn-prov').addEventListener('click', async () => {
    const prov = document.getElementById('prov-input').value.trim();
    if (!prov) return alert('Inserisci una provincia');
    try {
        let data = await safeFetch(`/distributori/provincia/${encodeURIComponent(prov)}`);
        if (!data.length) {
            alert(`Nessun distributore trovato per la provincia: ${prov}`);
            return;
        }
        generaElenco(data, 'prov-result');
        aggiornaMappa(data);
    } catch (err) {
        alert("Errore nella ricerca per provincia: " + (err.message || err));
    }
});

document.getElementById('btn-id').addEventListener('click', async () => {
    const id = document.getElementById('id-input').value;
    if (!id) return alert('Inserisci un ID');
    try {
        let data = await safeFetch(`/distributori/${id}`);
        data = Array.isArray(data) ? data : [data];
        generaElenco(data, 'id-result');
        aggiornaMappa(data);
    } catch (err) {
        alert("Errore nella ricerca per ID: " + (err.message || err));
    }
});

document.getElementById('btn-change-price').addEventListener('click', async () => {
    const prov = document.getElementById('prov-price').value.trim();
    const tipo = document.getElementById('tipo-price').value;
    const nuovo = document.getElementById('new-price').value;
    if (!prov || !tipo || !nuovo) return alert('Compila tutti i campi');
    try {
        let data = await safeFetch(`/distributori/prezzo/${encodeURIComponent(prov)}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({tipo: tipo, nuovo_prezzo: parseFloat(nuovo)})
        });
        generaElenco(data, 'change-result');
        aggiornaMappa(data);
    } catch (err) {
        alert("Errore nell'aggiornamento prezzi: " + (err.message || err));
    }
});
</script>
</body>
</html>
